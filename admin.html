<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<style>
    body { 
        font-family: Arial, sans-serif; 
        margin: 20px; 
        background-color: #f5f5f5;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
        color: #333;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
    }
    h2 {
        color: #444;
        margin-top: 30px;
    }
    .section {
        background-color: #f9f9f9;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        border-left: 4px solid #4CAF50;
    }
    input, button, textarea, select { 
        margin: 5px 0; 
        padding: 8px; 
        width: 100%; 
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    button {
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    button:hover {
        background-color: #45a049;
    }
    .delete-btn {
        background-color: #f44336;
    }
    .delete-btn:hover {
        background-color: #d32f2f;
    }
    #debug { 
        border: 1px solid #ccc; 
        padding: 10px; 
        max-height: 200px; 
        overflow-y: scroll; 
        background-color: #f9f9f9;
        font-family: monospace;
        font-size: 12px;
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .data-table th, .data-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    .data-table th {
        background-color: #f2f2f2;
    }
    .data-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    .data-table tr:hover {
        background-color: #f1f1f1;
    }
    .tab-container {
        margin-top: 20px;
    }
    .tab-buttons {
        display: flex;
        border-bottom: 1px solid #ddd;
    }
    .tab-button {
        padding: 10px 20px;
        background-color: #f1f1f1;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s;
    }
    .tab-button.active {
        background-color: white;
        border-bottom: 2px solid #4CAF50;
        font-weight: bold;
    }
    .tab-content {
        display: none;
        padding: 20px 0;
    }
    .tab-content.active {
        display: block;
    }
    .product-image {
        max-width: 100px;
        max-height: 100px;
        object-fit: cover;
    }
    .status-select {
        width: auto;
        padding: 5px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
</style>
</head>
<body>

<div class="container">
    <h1>Admin Panel - PijamaChic</h1>
    
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab('products')">Produits</button>
            <button class="tab-button" onclick="openTab('orders')">Commandes</button>
            <button class="tab-button" onclick="openTab('comments')">Commentaires</button>
        </div>
        
        <!-- Products Tab -->
        <div id="products" class="tab-content active">
            <div class="section">
                <h2>Ajouter un produit</h2>
                <div class="form-group">
                    <label for="productId">ID du produit:</label>
                    <input type="text" id="productId" placeholder="PJ-001">
                </div>
                <div class="form-group">
                    <label for="productName">Nom du produit:</label>
                    <input type="text" id="productName" placeholder="Pyjama en soie">
                </div>
                <div class="form-group">
                    <label for="productPrice">Prix (MAD):</label>
                    <input type="number" id="productPrice" placeholder="299">
                </div>
                <div class="form-group">
                    <label for="productCategory">Catégorie:</label>
                    <input type="text" id="productCategory" placeholder="Pyjama Femme">
                </div>
                <div class="form-group">
                    <label for="productCollection">Collection:</label>
                    <input type="text" id="productCollection" placeholder="Été 2024">
                </div>
                <div class="form-group">
                    <label for="productDescription">Description:</label>
                    <textarea id="productDescription" placeholder="Description du produit..." rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="productImage">Image du produit:</label>
                    <input type="file" id="productImage" accept="image/*">
                </div>
                <button onclick="addProduct()">Ajouter Produit</button>
            </div>

            <div class="section">
                <h2>Produits existants</h2>
                <div id="productsList"></div>
            </div>
        </div>
        
        <!-- Orders Tab -->
        <div id="orders" class="tab-content">
            <div class="section">
                <h2>Commandes</h2>
                <div id="ordersList"></div>
            </div>
        </div>
        
        <!-- Comments Tab -->
        <div id="comments" class="tab-content">
            <div class="section">
                <h2>Commentaires du formulaire de contact</h2>
                <div id="commentsList"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Debug Info</h2>
        <pre id="debug"></pre>
    </div>
</div>

<script>
// ========== CONFIGURATION ==========
const SHEET_ID = '1O8E8_Ju_IjeMc9qIHxmCi0Nm3_3vtD4rkKP5DkiDj90'; // REPLACE WITH YOUR GOOGLE SHEET ID
const API_KEY = 'AIzaSyCDpp1kxzhLS4ByMpm526_ojfFsa-hvcnc'; // REPLACE WITH YOUR GOOGLE API KEY

// Sheet configuration
const SHEETS = {
    PRODUCTS: 'PijamaChic Products',
    ORDERS: 'orders', 
    COMMENTS: 'comments'
};

// Base URL for Google Sheets API
const SHEETS_API_BASE = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}`;

// ========== UTILITY FUNCTIONS ==========
function addDebugInfo(message) {
    const debugElement = document.getElementById('debug');
    const timestamp = new Date().toLocaleTimeString();
    debugElement.innerHTML += `[${timestamp}] ${message}\n`;
    debugElement.scrollTop = debugElement.scrollHeight;
}

function generateId() {
    return 'ID-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
}

// ========== TAB MANAGEMENT ==========
function openTab(tabName) {
    // Hide all tab content
    const tabContents = document.getElementsByClassName('tab-content');
    for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
    }
    
    // Remove active class from all tab buttons
    const tabButtons = document.getElementsByClassName('tab-button');
    for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
    }
    
    // Show the specific tab content
    document.getElementById(tabName).classList.add('active');
    
    // Add active class to the button that opened the tab
    event.currentTarget.classList.add('active');
    
    // Load data for the selected tab
    if (tabName === 'orders') {
        loadOrders();
    } else if (tabName === 'comments') {
        loadComments();
    } else if (tabName === 'products') {
        loadProducts();
    }
}

// ========== PRODUCTS MANAGEMENT ==========
async function loadProducts() {
    try {
        addDebugInfo('Chargement des produits...');
        const response = await fetch(`${SHEETS_API_BASE}/values/${SHEETS.PRODUCTS}?key=${API_KEY}`);
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.values && data.values.length > 1) {
            const products = data.values.slice(1).map(row => ({
                date_added: row[0],
                id: row[1],
                name: row[2],
                price: row[3],
                category: row[4],
                collection: row[5],
                description: row[6],
                image: row[7] || 'https://via.placeholder.com/100?text=No+Image'
            }));
            
            addDebugInfo(`${products.length} produits chargés`);
            displayProducts(products);
        } else {
            addDebugInfo('Aucun produit trouvé');
            document.getElementById('productsList').innerHTML = '<p>Aucun produit trouvé. Ajoutez votre premier produit!</p>';
        }
    } catch(err) {
        addDebugInfo('Erreur chargement produits: ' + err.message);
        document.getElementById('productsList').innerHTML = '<p style="color: red;">Erreur de chargement: ' + err.message + '</p>';
    }
}

function displayProducts(products) {
    const list = document.getElementById('productsList');
    list.innerHTML = '';
    
    if (products.length === 0) {
        list.innerHTML = '<p>Aucun produit trouvé.</p>';
        return;
    }
    
    const table = document.createElement('table');
    table.className = 'data-table';
    
    // Create table header
    const header = table.insertRow();
    header.innerHTML = `
        <th>Image</th>
        <th>ID</th>
        <th>Nom</th>
        <th>Prix</th>
        <th>Catégorie</th>
        <th>Collection</th>
        <th>Description</th>
        <th>Actions</th>
    `;
    
    // Add products to table
    products.forEach(p => {
        const row = table.insertRow();
        row.innerHTML = `
            <td><img src="${p.image}" class="product-image" alt="${p.name}" onerror="this.src='https://via.placeholder.com/100?text=Image+Error'"></td>
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.price} MAD</td>
            <td>${p.category}</td>
            <td>${p.collection}</td>
            <td>${p.description.substring(0, 50)}${p.description.length > 50 ? '...' : ''}</td>
            <td>
                <button class="delete-btn" onclick="deleteProduct('${p.id}')">Supprimer</button>
            </td>
        `;
    });
    
    list.appendChild(table);
}

async function addProduct() {
    try {
        // Get form values
        const id = document.getElementById('productId').value || generateId();
        const name = document.getElementById('productName').value;
        const price = document.getElementById('productPrice').value;
        const category = document.getElementById('productCategory').value;
        const collection = document.getElementById('productCollection').value;
        const description = document.getElementById('productDescription').value;
        const fileInput = document.getElementById('productImage');
        
        // Validation
        if (!name || !price || !category) {
            alert('Veuillez remplir au moins le nom, le prix et la catégorie');
            return;
        }

        let imageUrl = 'https://via.placeholder.com/500x500?text=No+Image';
        
        // Handle image upload
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.size > 5 * 1024 * 1024) {
                alert('Image trop volumineuse (max 5MB)');
                return;
            }
            // For now, we'll use placeholder. In production, you'd upload to a service
            imageUrl = `https://via.placeholder.com/500x500/4CAF50/white?text=${encodeURIComponent(name)}`;
            addDebugInfo('Image utilisée: placeholder (upload désactivé pour CORS)');
        }

        // Prepare product data
        const productData = [
            new Date().toISOString(),
            id,
            name,
            price,
            category,
            collection,
            description,
            imageUrl
        ];

        addDebugInfo('Ajout du produit...');
        
        // Append to Google Sheet
        const response = await fetch(`${SHEETS_API_BASE}/values/${SHEETS.PRODUCTS}!A:A:append?valueInputOption=RAW&key=${API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                values: [productData]
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'Erreur inconnue');
        }

        addDebugInfo('Produit ajouté avec succès!');
        
        // Clear form
        document.getElementById('productId').value = '';
        document.getElementById('productName').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productCategory').value = '';
        document.getElementById('productCollection').value = '';
        document.getElementById('productDescription').value = '';
        document.getElementById('productImage').value = '';
        
        // Reload products
        loadProducts();
        
    } catch(err) {
        addDebugInfo('Erreur ajout produit: ' + err.message);
        alert('Erreur: ' + err.message);
    }
}

async function deleteProduct(productId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce produit?')) return;
    
    addDebugInfo('Suppression du produit: ' + productId);
    alert('La suppression directe via API nécessite une configuration supplémentaire. Pour le moment, supprimez manuellement depuis Google Sheets.');
}

// ========== ORDERS MANAGEMENT ==========
async function loadOrders() {
    try {
        addDebugInfo('Chargement des commandes...');
        const response = await fetch(`${SHEETS_API_BASE}/values/${SHEETS.ORDERS}?key=${API_KEY}`);
        const data = await response.json();
        
        if (data.values && data.values.length > 1) {
            const orders = data.values.slice(1).map(row => {
                try {
                    const products = typeof row[5] === 'string' && row[5] ? JSON.parse(row[5]) : [];
                    return {
                        date: row[0],
                        id: row[1],
                        customerName: row[2],
                        email: row[3],
                        customerPhone: row[4],
                        products: products,
                        total: row[6],
                        address: row[7],
                        status: row[8] || 'pending'
                    };
                } catch (e) {
                    return {
                        date: row[0],
                        id: row[1],
                        customerName: row[2],
                        email: row[3],
                        customerPhone: row[4],
                        products: [],
                        total: row[6],
                        address: row[7],
                        status: row[8] || 'pending'
                    };
                }
            });
            
            addDebugInfo(`${orders.length} commandes chargées`);
            displayOrders(orders);
        } else {
            document.getElementById('ordersList').innerHTML = `
                <p>Aucune commande trouvée.</p>
                <p><strong>Pour ajouter des commandes:</strong> 
                Les commandes seront ajoutées automatiquement quand les clients passeront commande sur votre site.</p>
            `;
        }
    } catch(err) {
        addDebugInfo('Erreur chargement commandes: ' + err.message);
        document.getElementById('ordersList').innerHTML = '<p style="color: red;">Erreur de chargement: ' + err.message + '</p>';
    }
}

function displayOrders(orders) {
    const list = document.getElementById('ordersList');
    list.innerHTML = '';
    
    if (orders.length === 0) {
        list.innerHTML = '<p>Aucune commande trouvée.</p>';
        return;
    }
    
    const table = document.createElement('table');
    table.className = 'data-table';
    
    const header = table.insertRow();
    header.innerHTML = `
        <th>ID Commande</th>
        <th>Client</th>
        <th>Email</th>
        <th>Téléphone</th>
        <th>Produits</th>
        <th>Total</th>
        <th>Adresse</th>
        <th>Statut</th>
        <th>Date</th>
    `;
    
    orders.forEach(order => {
        const row = table.insertRow();
        let productsHtml = 'Aucun produit';
        
        if (order.products && order.products.length > 0) {
            productsHtml = '<ul style="margin: 0; padding-left: 15px; max-width: 200px;">';
            order.products.forEach(product => {
                productsHtml += `<li>${product.name || 'Produit'} (x${product.quantity || 1})</li>`;
            });
            productsHtml += '</ul>';
        }
        
        row.innerHTML = `
            <td>${order.id || 'N/A'}</td>
            <td>${order.customerName || 'N/A'}</td>
            <td>${order.email || 'N/A'}</td>
            <td>${order.customerPhone || 'N/A'}</td>
            <td>${productsHtml}</td>
            <td>${order.total || '0'} MAD</td>
            <td>${order.address || 'N/A'}</td>
            <td>
                <select class="status-select" onchange="updateOrderStatus('${order.id}', this.value)">
                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>En attente</option>
                    <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmée</option>
                    <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Expédiée</option>
                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Livrée</option>
                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Annulée</option>
                </select>
            </td>
            <td>${order.date ? new Date(order.date).toLocaleDateString('fr-FR') : 'N/A'}</td>
        `;
    });
    
    list.appendChild(table);
}

async function updateOrderStatus(orderId, newStatus) {
    addDebugInfo(`Mise à jour statut commande ${orderId} -> ${newStatus}`);
    alert('La mise à jour du statut nécessite une configuration API avancée. Mettez à jour manuellement dans Google Sheets.');
}

// ========== COMMENTS MANAGEMENT ==========
async function loadComments() {
    try {
        addDebugInfo('Chargement des commentaires...');
        const response = await fetch(`${SHEETS_API_BASE}/values/${SHEETS.COMMENTS}?key=${API_KEY}`);
        const data = await response.json();
        
        if (data.values && data.values.length > 1) {
            const comments = data.values.slice(1).map(row => ({
                date: row[0],
                id: row[1],
                name: row[2],
                email: row[3],
                message: row[4],
                rating: row[5] || '',
                productId: row[6] || ''
            }));
            
            addDebugInfo(`${comments.length} commentaires chargés`);
            displayComments(comments);
        } else {
            document.getElementById('commentsList').innerHTML = `
                <p>Aucun commentaire trouvé.</p>
                <p><strong>Pour ajouter des commentaires:</strong> 
                Les commentaires seront ajoutés automatiquement quand les clients utiliseront votre formulaire de contact.</p>
            `;
        }
    } catch(err) {
        addDebugInfo('Erreur chargement commentaires: ' + err.message);
        document.getElementById('commentsList').innerHTML = '<p style="color: red;">Erreur de chargement: ' + err.message + '</p>';
    }
}

function displayComments(comments) {
    const list = document.getElementById('commentsList');
    list.innerHTML = '';
    
    if (comments.length === 0) {
        list.innerHTML = '<p>Aucun commentaire trouvé.</p>';
        return;
    }
    
    const table = document.createElement('table');
    table.className = 'data-table';
    
    const header = table.insertRow();
    header.innerHTML = `
        <th>Nom</th>
        <th>Email</th>
        <th>Message</th>
        <th>Note</th>
        <th>Date</th>
        <th>Actions</th>
    `;
    
    comments.forEach(comment => {
        const row = table.insertRow();
        const ratingStars = comment.rating ? '★'.repeat(comment.rating) + '☆'.repeat(5-comment.rating) : 'N/A';
        
        row.innerHTML = `
            <td>${comment.name || 'N/A'}</td>
            <td>${comment.email || 'N/A'}</td>
            <td style="max-width: 300px;">${comment.message || 'N/A'}</td>
            <td>${ratingStars}</td>
            <td>${comment.date ? new Date(comment.date).toLocaleDateString('fr-FR') : 'N/A'}</td>
            <td>
                <button class="delete-btn" onclick="deleteComment('${comment.id}')">Supprimer</button>
            </td>
        `;
    });
    
    list.appendChild(table);
}

async function deleteComment(commentId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce commentaire?')) return;
    addDebugInfo('Suppression commentaire: ' + commentId);
    alert('La suppression directe via API nécessite une configuration supplémentaire. Pour le moment, supprimez manuellement depuis Google Sheets.');
}

// ========== INITIALIZATION ==========
// Load products on page load
loadProducts();

// Add sample data button for testing
document.addEventListener('DOMContentLoaded', function() {
    const productsSection = document.querySelector('#products .section:first-child');
    const testButton = document.createElement('button');
    testButton.textContent = 'Remplir avec des exemples (Test)';
    testButton.style.backgroundColor = '#2196F3';
    testButton.style.marginTop = '10px';
    testButton.onclick = fillSampleData;
    productsSection.appendChild(testButton);
});

async function fillSampleData() {
    const sampleProducts = [
        [
            new Date().toISOString(),
            'PJ-001',
            'Pyjama en Soie Luxe',
            '459',
            'Pyjama Femme',
            'Collection Élégance',
            'Pyjama en soie naturelle, confort exceptionnel pour vos nuits.',
            'https://via.placeholder.com/500x500/4CAF50/white?text=Pyjama+Soie'
        ],
        [
            new Date().toISOString(),
            'PJ-002', 
            'Pyjama Coton Bio',
            '299',
            'Pyjama Homme',
            'Collection Confort',
            'Pyjama 100% coton biologique, idéal pour un sommeil paisible.',
            'https://via.placeholder.com/500x500/2196F3/white?text=Pyjama+Coton'
        ]
    ];

    try {
        for (const product of sampleProducts) {
            await fetch(`${SHEETS_API_BASE}/values/${SHEETS.PRODUCTS}!A:A:append?valueInputOption=RAW&key=${API_KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({values: [product]})
            });
        }
        addDebugInfo('Données exemple ajoutées!');
        loadProducts();
    } catch(err) {
        addDebugInfo('Erreur ajout exemples: ' + err.message);
    }
}
</script>

</body>
</html>
