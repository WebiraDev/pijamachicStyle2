<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button, textarea { margin: 5px 0; padding: 8px; width: 100%; }
    #debug { border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: scroll; }
</style>
</head>
<body>

<h1>Admin Panel</h1>

<h2>Ajouter un produit</h2>
<input type="text" id="productId" placeholder="ID du produit">
<input type="text" id="productName" placeholder="Nom du produit">
<input type="number" id="productPrice" placeholder="Prix">
<input type="text" id="productCategory" placeholder="Catégorie">
<input type="text" id="productCollection" placeholder="Collection">
<textarea id="productDescription" placeholder="Description"></textarea>
<input type="file" id="productImage">
<button onclick="addProduct()">Ajouter Produit</button>

<h2>Produits existants</h2>
<div id="productsList"></div>

<h2>Debug Info</h2>
<pre id="debug"></pre>

<script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzuKjobQzfLsu85C1yOzsoBEvw3fO3-5pObOvjXiJRUZLPCEFoU77USAjD4mOzYfv28/exec';
const debugInfo = document.getElementById('debug');

function addDebugInfo(msg){
    const now = new Date().toLocaleTimeString();
    debugInfo.textContent += `[${now}] ${msg}\n`;
    debugInfo.scrollTop = debugInfo.scrollHeight;
}

// --- LOAD PRODUCTS ---
async function loadProducts(){
    try {
        addDebugInfo('Chargement des produits...');
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getProducts`);
        const result = await response.json();
        if(result.success && result.data){
            addDebugInfo(`${result.data.length} produits chargés`);
            const list = document.getElementById('productsList');
            list.innerHTML = '';
            result.data.forEach(p => {
                const div = document.createElement('div');
                div.innerHTML = `<strong>${p.name}</strong> - ${p.price} MAD
                <br><img src="${p.image}" width="100">
                <br><button onclick="deleteProduct('${p.id}')">Supprimer</button><hr>`;
                list.appendChild(div);
            });
        }
    } catch(err){
        addDebugInfo('Erreur chargement produits: ' + err.message);
    }
}

// --- ADD PRODUCT ---
async function addProduct(){
    try {
        const id = document.getElementById('productId').value;
        const name = document.getElementById('productName').value;
        const price = document.getElementById('productPrice').value;
        const category = document.getElementById('productCategory').value;
        const collection = document.getElementById('productCollection').value;
        const description = document.getElementById('productDescription').value;
        const file = document.getElementById('productImage').files[0];

        if(!file){
            alert('Veuillez choisir une image');
            return;
        }

        if(file.size > 100 * 1024 * 1024){
            alert('Fichier trop gros (max 100 MB)');
            return;
        }

        addDebugInfo(`Fichier sélectionné: ${file.name}, taille: ${file.size} bytes, type: ${file.type}`);

        const reader = new FileReader();
        reader.onload = async function(e){
            const base64 = e.target.result;
            addDebugInfo(`Image convertie en base64, taille: ${base64.length} caractères`);

            const payload = {
                action: 'addProduct',
                id, name, price, category, collection, description,
                imageBlobBase64: base64,
                imageMimeType: file.type,
                imageName: file.name
            };

            addDebugInfo('Début de l\'ajout du produit...');
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if(result.success){
                addDebugInfo('Produit ajouté avec succès');
                loadProducts();
            } else {
                addDebugInfo('Erreur ajout produit: ' + result.message);
            }
        };
        reader.readAsDataURL(file);

    } catch(err){
        addDebugInfo('Erreur: ' + err.message);
    }
}

// --- DELETE PRODUCT ---
async function deleteProduct(productId){
    try {
        const payload = {action: 'deleteProduct', productId};
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        if(result.success){
            addDebugInfo('Produit supprimé');
            loadProducts();
        } else {
            addDebugInfo('Erreur suppression produit');
        }
    } catch(err){
        addDebugInfo('Erreur suppression produit: ' + err.message);
    }
}

// --- INITIAL LOAD ---
loadProducts();
</script>

</body>
</html>

